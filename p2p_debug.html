<!DOCTYPE html>
<html>
<head>
    <title>P2P Debug</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .videos { flex: 1; }
        .debug-panel { flex: 1; }
        video { width: 100%; max-width: 400px; background: #000; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .logs { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            padding: 10px; 
            height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            margin: 10px 0; 
        }
        button { 
            padding: 8px 15px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        #hangupButton { background: #dc3545; }
        #copyButton { background: #28a745; }
        #pasteButton { background: #17a2b8; }
        .signal-box { 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            background: #f8f9fa;
        }
        textarea { 
            width: 100%; 
            height: 60px; 
            margin: 10px 0; 
            font-family: monospace; 
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>P2P Debug</h1>
    
    <div class="container">
        <div class="videos">
            <h3>Local Video</h3>
            <video id="localVideo" autoplay playsinline muted></video>
            
            <h3>Remote Video</h3>
            <video id="remoteVideo" autoplay playsinline></video>
            
            <div class="controls">
                <button id="startButton">Start</button>
                <button id="callButton" disabled>Call</button>
                <button id="hangupButton" disabled>Hang Up</button>
                <button id="toggleVideo" disabled>Start Video</button>
            </div>
            
            <div id="connectionStatus" class="status disconnected">Status: Disconnected</div>
        </div>
        
        <div class="debug-panel">
            <h3>Debug Panel</h3>
            
            <div class="signal-box">
                <h4>Manual Signaling</h4>
                <p>If automatic signaling fails, use these buttons:</p>
                <button id="copyButton">Copy Offer/Answer</button>
                <button id="pasteButton">Paste Offer/Answer</button>
                <textarea id="signalData" placeholder="Paste signal data here..."></textarea>
            </div>
            
            <h4>Connection Logs</h4>
            <div id="debugLog" class="logs"></div>
            
            <div>
                <h4>Chat</h4>
                <div id="chatLog" class="logs"></div>
                <div style="margin-top: 10px;">
                    <input type="text" id="messageInput" placeholder="Type a message..." disabled>
                    <button id="sendButton" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startButton = document.getElementById('startButton');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');
        const toggleVideoButton = document.getElementById('toggleVideo');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatLog = document.getElementById('chatLog');
        const debugLog = document.getElementById('debugLog');
        const statusDiv = document.getElementById('connectionStatus');
        const copyButton = document.getElementById('copyButton');
        const pasteButton = document.getElementById('pasteButton');
        const signalData = document.getElementById('signalData');

        // WebRTC Variables
        let localStream;
        let peerConnection;
        let dataChannel;
        let isCaller = false;
        const SIGNAL_KEY = 'p2p-debug-signal';
        let lastOffer = null;
        let lastAnswer = null;

        // Logging
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.color = type === 'error' ? '#dc3545' : 
                               type === 'success' ? '#28a745' : 
                               type === 'warn' ? '#ffc107' : '#6c757d';
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function logChat(message, isSelf = false) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.color = isSelf ? '#007bff' : '#28a745';
            messageDiv.style.textAlign = isSelf ? 'right' : 'left';
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function updateStatus(connected) {
            statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
            statusDiv.textContent = `Status: ${connected ? 'Connected' : 'Disconnected'}`;
        }

        // Start local media
        async function start() {
            try {
                log('Requesting media devices...');
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false 
                });
                
                localVideo.srcObject = localStream;
                log('Local media ready');
                
                // Set up signaling
                window.addEventListener('storage', handleSignal);
                
                // Enable UI
                callButton.disabled = false;
                toggleVideoButton.disabled = false;
                
                log('Ready to make or receive calls', 'success');
                
            } catch (err) {
                log(`Error accessing media devices: ${err.message}`, 'error');
            }
        }

        // Toggle video
        async function toggleVideo() {
            if (!localStream) return;
            
            try {
                if (!localStream.getVideoTracks().length) {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const videoTrack = stream.getVideoTracks()[0];
                    localStream.addTrack(videoTrack);
                    toggleVideoButton.textContent = 'Stop Video';
                    log('Video enabled');
                    
                    if (peerConnection) {
                        const senders = peerConnection.getSenders();
                        const videoSender = senders.find(s => s.track && s.track.kind === 'video');
                        
                        if (videoSender) {
                            await videoSender.replaceTrack(videoTrack);
                        } else {
                            peerConnection.addTrack(videoTrack, localStream);
                        }
                    }
                } else {
                    localStream.getVideoTracks().forEach(track => {
                        track.stop();
                        localStream.removeTrack(track);
                    });
                    toggleVideoButton.textContent = 'Start Video';
                    log('Video disabled');
                }
            } catch (err) {
                log(`Error toggling video: ${err.message}`, 'error');
            }
        }

        // Create peer connection
        function createPeerConnection() {
            try {
                log('Creating peer connection...');
                
                const config = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                peerConnection = new RTCPeerConnection(config);
                
                // Add local tracks
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                    log(`Added local ${track.kind} track`);
                });
                
                // Handle remote tracks
                peerConnection.ontrack = (event) => {
                    log(`Received remote ${event.track.kind} track`);
                    
                    if (!remoteVideo.srcObject) {
                        remoteVideo.srcObject = new MediaStream();
                    }
                    
                    const remoteStream = remoteVideo.srcObject;
                    const existingTracks = remoteStream.getTracks()
                        .filter(t => t.kind === event.track.kind);
                        
                    existingTracks.forEach(track => {
                        track.stop();
                        remoteStream.removeTrack(track);
                    });
                    
                    remoteStream.addTrack(event.track);
                    
                    if (event.track.kind === 'video') {
                        remoteVideo.play().catch(err => {
                            log(`Error playing remote video: ${err.message}`, 'error');
                        });
                    }
                };
                
                // Set up data channel if caller
                if (isCaller) {
                    log('Creating data channel...');
                    dataChannel = peerConnection.createDataChannel('chat');
                    setupDataChannel();
                } else {
                    peerConnection.ondatachannel = (event) => {
                        log('Data channel received');
                        dataChannel = event.channel;
                        setupDataChannel();
                    };
                }
                
                // ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        log('Sending ICE candidate');
                        sendSignal({ 
                            type: 'candidate', 
                            candidate: event.candidate 
                        });
                    }
                };
                
                // Connection state changes
                peerConnection.oniceconnectionstatechange = () => {
                    const state = peerConnection.iceConnectionState;
                    log(`ICE connection state: ${state}`);
                    
                    if (state === 'connected' || state === 'completed') {
                        updateStatus(true);
                        log('Connected to peer!', 'success');
                    } else if (state === 'disconnected' || state === 'failed') {
                        updateStatus(false);
                        log('Connection lost', 'error');
                        hangUp();
                    } else if (state === 'checking') {
                        updateStatus(false);
                        statusDiv.className = 'status connecting';
                        statusDiv.textContent = 'Status: Connecting...';
                    }
                };
                
                log('Peer connection created', 'success');
                return peerConnection;
                
            } catch (err) {
                log(`Error creating peer connection: ${err.message}`, 'error');
                throw err;
            }
        }

        // Set up data channel
        function setupDataChannel() {
            if (!dataChannel) {
                log('No data channel available', 'error');
                return;
            }
            
            dataChannel.onopen = () => {
                log('Data channel opened', 'success');
                messageInput.disabled = false;
                sendButton.disabled = false;
                logChat('Connected to peer', false);
                
                // Test message
                try {
                    dataChannel.send('Hello from ' + (isCaller ? 'caller' : 'callee'));
                } catch (err) {
                    log(`Error sending test message: ${err.message}`, 'error');
                }
            };
            
            dataChannel.onclose = () => {
                log('Data channel closed');
                messageInput.disabled = true;
                sendButton.disabled = true;
                logChat('Disconnected from peer', false);
            };
            
            dataChannel.onmessage = (event) => {
                log(`Received message: ${event.data}`, 'info');
                logChat(event.data, false);
            };
            
            dataChannel.onerror = (error) => {
                log(`Data channel error: ${error}`, 'error');
            };
        }

        // Send signal
        function sendSignal(signal) {
            log(`Sending signal: ${signal.type}`);
            
            // Store for manual copy
            if (signal.type === 'offer') lastOffer = signal;
            if (signal.type === 'answer') lastAnswer = signal;
            
            // Auto signaling via localStorage
            try {
                localStorage.setItem(SIGNAL_KEY, JSON.stringify(signal));
                setTimeout(() => localStorage.removeItem(SIGNAL_KEY), 100);
            } catch (err) {
                log('Error using localStorage, using manual signaling', 'warn');
                signalData.value = JSON.stringify(signal, null, 2);
            }
        }

        // Handle incoming signals
        async function handleSignal(event) {
            if (event.key !== SIGNAL_KEY || !event.newValue) return;
            
            try {
                const signal = JSON.parse(event.newValue);
                log(`Received signal: ${signal.type}`);
                
                if (!peerConnection && signal.type !== 'offer') {
                    log('No active peer connection for non-offer signal', 'warn');
                    return;
                }
                
                switch (signal.type) {
                    case 'offer':
                        if (isCaller) {
                            log('Received offer but already in a call', 'warn');
                            return;
                        }
                        
                        log('Received offer, creating peer connection...');
                        isCaller = false;
                        createPeerConnection();
                        
                        try {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(signal));
                            log('Set remote description');
                            
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            log('Created answer');
                            
                            sendSignal({ 
                                type: 'answer', 
                                sdp: answer.sdp 
                            });
                            
                            hangupButton.disabled = false;
                            callButton.disabled = true;
                            
                        } catch (err) {
                            log(`Error handling offer: ${err.message}`, 'error');
                            hangUp();
                        }
                        break;
                        
                    case 'answer':
                        log('Received answer');
                        try {
                            await peerConnection.setRemoteDescription(
                                new RTCSessionDescription(signal)
                            );
                            log('Call connected!', 'success');
                        } catch (err) {
                            log(`Error setting remote description: ${err.message}`, 'error');
                            hangUp();
                        }
                        break;
                        
                    case 'candidate':
                        if (signal.candidate) {
                            try {
                                await peerConnection.addIceCandidate(
                                    new RTCIceCandidate(signal.candidate)
                                );
                                log('Added ICE candidate');
                            } catch (err) {
                                if (err.name !== 'TypeError') {
                                    log(`Error adding ICE candidate: ${err.message}`, 'error');
                                }
                            }
                        }
                        break;
                }
            } catch (err) {
                log(`Error handling signal: ${err.message}`, 'error');
            }
        }

        // Start call
        async function call() {
            if (peerConnection) {
                log('Call already in progress', 'warn');
                return;
            }
            
            try {
                isCaller = true;
                log('Initiating call...');
                
                createPeerConnection();
                
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await peerConnection.setLocalDescription(offer);
                log('Created offer');
                
                sendSignal({ 
                    type: 'offer', 
                    sdp: offer.sdp 
                });
                
                callButton.disabled = true;
                hangupButton.disabled = false;
                
                log('Call initiated, waiting for answer...');
                
            } catch (err) {
                log(`Call error: ${err.message}`, 'error');
                hangUp();
            }
        }

        // Hang up
        function hangUp() {
            log('Ending call...');
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.getTransceivers().forEach(transceiver => {
                    if (transceiver.stop) {
                        transceiver.stop();
                    }
                });
                peerConnection.close();
                peerConnection = null;
            }
            
            // Close data channel
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            
            // Reset remote video
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            
            // Reset UI
            callButton.disabled = false;
            hangupButton.disabled = true;
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    toggleVideoButton.textContent = 'Stop Video';
                } else {
                    toggleVideoButton.textContent = 'Start Video';
                }
            }
            
            updateStatus(false);
            log('Call ended');
        }

        // Send chat message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (!dataChannel || dataChannel.readyState !== 'open') {
                log('Cannot send message: Data channel not ready', 'error');
                return;
            }
            
            try {
                dataChannel.send(message);
                logChat(`You: ${message}`, true);
                messageInput.value = '';
                messageInput.focus();
            } catch (err) {
                log(`Error sending message: ${err.message}`, 'error');
            }
        }

        // Manual signaling
        copyButton.addEventListener('click', () => {
            const signal = lastOffer || lastAnswer;
            if (signal) {
                signalData.value = JSON.stringify(signal, null, 2);
                signalData.select();
                document.execCommand('copy');
                log('Signal copied to clipboard', 'success');
            } else {
                log('No offer/answer to copy', 'warn');
            }
        });

        pasteButton.addEventListener('click', () => {
            try {
                const signal = JSON.parse(signalData.value);
                handleSignal({
                    key: SIGNAL_KEY,
                    newValue: JSON.stringify(signal)
                });
                log('Signal pasted and processed', 'success');
            } catch (err) {
                log('Invalid signal data', 'error');
            }
        });

        // Event Listeners
        startButton.addEventListener('click', start);
        callButton.addEventListener('click', call);
        hangupButton.addEventListener('click', hangUp);
        toggleVideoButton.addEventListener('click', toggleVideo);
        
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // Initialize
        log('Page loaded. Click Start to begin.');
        updateStatus(false);
    </script>
</body>
</html>
