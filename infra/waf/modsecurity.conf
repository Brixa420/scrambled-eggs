# ModSecurity configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 5242880
SecResponseBodyLimitAction ProcessPartial

# Audit log configuration
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsec_audit.log
SecAuditLogType Serial
SecAuditLogStorageDir /var/log/modsec/audit/
SecAuditLogParts ABIJDEFHZ

# Debug log
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Rule inclusion
Include /etc/modsecurity/crs/crs-setup.conf
Include /etc/modsecurity/rules/*.conf

# Custom rules
# Block common attack patterns
SecRule REQUEST_HEADERS:User-Agent "(libwww-perl|wget|curl|python|nikto|sqlmap|nmap|nessus|acunetix|burpsuite|dirbuster|wpscan)" \
    "id:1000,phase:1,deny,status:403,msg:'Bad User-Agent',tag:'MALICIOUS_SOFTWARE/TOOLS',severity:2"

# Block suspicious request methods
SecRule REQUEST_METHOD "!^(GET|POST|HEAD|OPTIONS)$" \
    "id:1001,phase:1,deny,status:405,msg:'Method not allowed',tag:'MALICIOUS_REQUEST_METHOD',severity:2"

# Block common attack patterns in query string
SecRule ARGS_NAMES|ARGS "(<|>|'|\"|\x00|\x08|\x0B|\x0C|\x0E|\x1F)" \
    "id:1002,phase:2,deny,status:400,msg:'SQL Injection Attack',tag:'WEB_ATTACK/SQL_INJECTION',severity:2"

# Block common web shells
SecRule REQUEST_FILENAME "(cmd\.exe|wget|curl|bash|sh|perl|python|php|ruby|nc|netcat|ncat|powershell)" \
    "id:1003,phase:2,deny,status:403,msg:'Possible Web Shell Upload',tag:'WEB_SHELL',severity:2"

# Rate limiting per IP
SecRule IP:bf_block "@gt 0" \
    "id:1004,phase:1,deny,status:429,msg:'IP blocked due to too many requests',tag:'IP_REPUTATION',chain"
    SecRule REQUEST_URI "!^/health$"

# Block common vulnerability scanners
SecRule REQUEST_HEADERS:User-Agent "(nikto|sqlmap|nmap|nessus|acunetix|burpsuite|dirbuster|wpscan)" \
    "id:1005,phase:1,deny,status:403,msg:'Vulnerability scanner detected',tag:'SCANNER_DETECTED',severity:2"
