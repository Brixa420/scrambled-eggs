<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Video Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
        }
        video {
            width: 100%;
            max-width: 400px;
            background: #000;
            border-radius: 4px;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:disabled {
            background: #cccccc;
        }
        #log {
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background: #f5f5f5;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>WebRTC Video Chat</h1>
    <div class="video-container">
        <div class="video-box">
            <h3>You</h3>
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="video-box">
            <h3>Remote</h3>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>

    <div class="controls">
        <button id="startButton" onclick="start()">Start</button>
        <button id="callButton" onclick="call()" disabled>Call</button>
        <button id="hangupButton" onclick="hangup()" disabled>Hang Up</button>
    </div>

    <div>
        <h3>Connection Log</h3>
        <div id="log"></div>
    </div>

    <script>
        // DOM elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callButton = document.getElementById('callButton');
        const hangupButton = document.getElementById('hangupButton');
        const logElement = document.getElementById('log');

        // Configuration
        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // WebRTC variables
        let localStream;
        let peerConnection;
        let socket;
        const roomId = 'video_chat_room';
        const peerId = 'user_' + Math.random().toString(36).substr(2, 9);
        const serverUrl = 'ws://localhost:9000/ws';

        // Log function
        function log(message) {
            const entry = document.createElement('div');
            entry.textContent = message;
            logElement.prepend(entry);
            console.log(message);
        }

        // Start the application
        async function start() {
            log('Getting user media...');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });
                log('Got local stream');
                localVideo.srcObject = stream;
                localStream = stream;
                document.getElementById('startButton').disabled = true;
                callButton.disabled = false;
                connectToSignalingServer();
            } catch (err) {
                log('Error accessing media devices: ' + err.message);
            }
        }

        // Connect to WebSocket server
        function connectToSignalingServer() {
            socket = new WebSocket(`${serverUrl}?peer_id=${peerId}&room_id=${roomId}`);
            
            socket.onopen = () => {
                log('Connected to signaling server');
            };

            socket.onmessage = async (event) => {
                const message = JSON.parse(event.data);
                log('Received message: ' + message.type);
                
                if (message.sender_id === peerId) return; // Ignore our own messages

                if (message.type === 'offer') {
                    await handleOffer(message);
                } else if (message.type === 'answer') {
                    await handleAnswer(message);
                } else if (message.type === 'candidate') {
                    await handleCandidate(message);
                }
            };
        }

        // Create and set up peer connection
        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local stream to connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        candidate: event.candidate,
                        target_peer_id: 'all' // Broadcast to all peers
                    }));
                }
            };

            // Handle remote stream
            peerConnection.ontrack = event => {
                log('Received remote stream');
                remoteVideo.srcObject = event.streams[0];
            };
        }

        // Handle incoming offer
        async function handleOffer(offer) {
            log('Received offer');
            await createPeerConnection();
            await peerConnection.setRemoteDescription(offer);
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.send(JSON.stringify({
                type: 'answer',
                sdp: answer.sdp,
                target_peer_id: offer.sender_id
            }));
            
            hangupButton.disabled = false;
        }

        // Handle incoming answer
        async function handleAnswer(answer) {
            log('Received answer');
            await peerConnection.setRemoteDescription(answer);
        }

        // Handle ICE candidate
        async function handleCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(candidate);
            } catch (e) {
                log('Error adding ICE candidate: ' + e.toString());
            }
        }

        // Initiate a call
        async function call() {
            log('Starting call...');
            callButton.disabled = true;
            await createPeerConnection();
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.send(JSON.stringify({
                type: 'offer',
                sdp: offer.sdp,
                target_peer_id: 'all' // Broadcast to all peers
            }));
            
            hangupButton.disabled = false;
        }

        // Hang up the call
        function hangup() {
            log('Ending call');
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (remoteVideo.srcObject) {
                remoteVideo.srcObject.getTracks().forEach(track => track.stop());
                remoteVideo.srcObject = null;
            }
            hangupButton.disabled = true;
            callButton.disabled = false;
        }

        // Clean up on page unload
        window.onbeforeunload = () => {
            if (socket) {
                socket.close();
            }
            hangup();
        };
    </script>
</body>
</html>