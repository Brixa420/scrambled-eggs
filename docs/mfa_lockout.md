# Multi-Factor Authentication (MFA) Lockout

## Overview
This document describes the MFA lockout feature that helps protect user accounts from brute force attacks by temporarily locking accounts after multiple failed MFA attempts.

## Feature Details

### Lockout Conditions
- After **5 failed MFA attempts**, the account is locked for **15 minutes**
- Failed attempts are tracked within a **5-minute window**
- Lockout counter resets after successful verification or lockout expiration

### Rate Limiting
- **5 MFA verification attempts** allowed per **5 minutes** per IP address
- Additional requests are rate limited with a 429 status code

### Backup Codes
- Backup codes can be used even when TOTP is locked
- Each backup code is single-use
- New backup codes can be generated by the user

## API Endpoints

### Verify MFA Code

```http
POST /api/v1/mfa/verify
```

**Request Body:**
```json
{
  "mfa_token": "string",
  "code": "string",
  "method": "totp" | "backup"
}
```

**Responses:**
- `200 OK`: Verification successful
  ```json
  {
    "access_token": "string",
    "token_type": "bearer"
  }
  ```

- `400 Bad Request`: Invalid code
  ```json
  {
    "message": "Invalid verification code",
    "remaining_attempts": 3
  }
  ```

- `403 Forbidden`: Account locked
  ```json
  {
    "message": "Account locked due to too many failed attempts",
    "retry_after": 300,
    "remaining_attempts": 0
  }
  ```

- `429 Too Many Requests`: Rate limited
  ```json
  {
    "message": "Too many requests",
    "retry_after": 60
  }
  ```

## User Experience

### During Lockout
- Users see a countdown timer showing when they can try again
- Clear error message explains the lockout status
- Backup code option remains available

### After Lockout
- Users can attempt MFA verification again
- The failed attempt counter is reset
- Users receive remaining attempt count with each failed attempt

## Security Considerations
- Lockout duration is intentionally short (15 minutes) to balance security and usability
- Failed attempt counters are stored securely in the database
- All verification attempts are logged for security auditing
- Rate limiting helps prevent brute force attacks

## Recovery Options
1. Wait for the lockout period to expire (15 minutes)
2. Use a backup code to bypass the lockout
3. Contact support if permanently locked out

## Testing
Run the test suite with:
```bash
pytest tests/test_mfa_lockout.py -v
```

## Monitoring and Logging
- Failed MFA attempts are logged with timestamps and IP addresses
- Lockout events are recorded in the security log
- Monitoring alerts are triggered for unusual patterns of failed attempts

## Troubleshooting

### Common Issues
1. **Locked out immediately after entering correct code**
   - Check server time synchronization (TOTP is time-sensitive)
   - Verify the authenticator app is generating valid codes

2. **Backup code not working**
   - Ensure the code hasn't been used before
   - Check for leading/trailing spaces when copying the code

3. **Persistent lockout issues**
   - Verify the database connection is stable
   - Check for any timezone configuration issues

## Related Documentation
- [MFA Setup Guide](./mfa_setup.md)
- [API Security Guidelines](./api_security.md)
- [User Authentication Flow](./auth_flow.md)
